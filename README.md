# 重要！！！

## 注意事项：

1. 由于多线程资源读取的代码问题，偶尔开启游戏会出现贴图丢失或卡死，此属于正常现象，重启游戏便可。
2. 尽量避免使用窗口控件关闭窗口，容易线程冲突，尤其是处于关卡中，绝对不要直接关闭窗口。
3. 请不要动着色器，这不是开放式渲染引擎，所以不懂如何修改着色器请不要动，否则黑屏或卡死。
4. 你可以修改的地方是资源文件，如果你愿意研究的话可以添加你自己的敌人或者子弹数据之类的，但是注意，所有数据格式必须与当前文件格式保持一致，否则出错。
5. 核心的`lua`脚本代码在`resources/lua_scripts`，如果你不懂的话不太建议修改除了`stage.lua`和`stagebcg.lua`以外的其他`lua`脚本，否则出错。（可以热重载，修改脚本后重新开始关卡就好了）
6. 所有资源文件来自东方project系列解包文件和LuaSTG部分资源文件。

## LuaAPI

### 说明：

所有`id`均在对应的`json`里进行实现，一般默认`"type" = "id" = "name"`，但是每个文件里必须相同，Lua脚本里这三种都可以直接拿来用。`"source"`一般是指来自哪张图片，`name/type/id`则表示一个特定`"id"`，两者不同。目前不能添加新玩家。

### 背景控制（渲染图片的话必须先在`data/resource.json`里添加）

| 调用                                                         | 参数列表                 | 默认值 | 单位/范围                       | 返回 | 说明                                         |
| ------------------------------------------------------------ | ------------------------ | ------ | ------------------------------- | ---- | -------------------------------------------- |
| `Set3D('eye', x, y, z)`                                      | 3×number                 | 必填   | 世界坐标（像素）                | 无   | 立即设置摄像机 **自身位置**                  |
| `Set3D('at', x, y, z)`                                       | 3×number                 | 必填   | 世界坐标                        | 无   | 设置摄像机 **看向点**                        |
| `Set3D('up', x, y, z)`                                       | 3×number                 | 必填   | 世界向量                        | 无   | 设置摄像机 **上方向**（通常 0,1,0）          |
| `Set3D('fovy', fov)`                                         | 1×number                 | 必填   | 度（0~180）                     | 无   | 垂直视野                                     |
| `Set3D('z', near, far)`                                      | 2×number                 | 必填   | 世界单位                        | 无   | 设置深度裁剪面                               |
| `Set3D('fog', start, end, r, g, b)`                          | 5×number                 | 必填   | start/end：世界距离；rgb：0~255 | 无   | 开启/更新雾效                                |
| `SetImageState(id, mode, r, g, b, a)`                        | string, string, 4×number | a=255  | 颜色 0~255                      | 无   | 设置四边形混合模式及顶点色                   |
| `Render4V(id, x1,y1,z1, ..., x4,y4,z4)`                      | 1+12×number              | 必填   | 世界坐标                        | 无   | 手动画 1 张纹理四边形（左上→右上→右下→左下） |
| `Render4VMix(idBase, idMix, factor, x1,y1,z1, ..., x4,y4,z4)` | 2+1+12×number            | 必填   | factor：0~1                     | 无   | 同上，但支持两张纹理 alpha 混合              |

### 敌人控制(参考`data/enemy_config.json`)

| 调用                                    | 参数列表                | 默认值   | 单位/范围            | 返回 | 说明                        |
| --------------------------------------- | ----------------------- | -------- | -------------------- | ---- | --------------------------- |
| `CreateEnemy(id, x, y, health, dropId)` | string, 3×number, 2×int | dropId=0 | 坐标：像素；血量：>0 | int  | 返回敌人索引（后续 API 用） |
| `Enemy_SetPosition(idx, x, y)`          | int, 2×number           | 必填     | 像素                 | 无   | 立即瞬移                    |
| `Enemy_GetPosition(idx)`                | int                     | 必填     | -                    | x, y | 两个 number                 |
| `Enemy_IsValid(idx)`                    | int                     | 必填     | -                    | bool | true=仍在场                 |
| `Enemy_Health(idx)`                     | int                     | 必填     | -                    | int  | 返回生命值                  |

### 子弹与角度（子弹配置参考`data/bullet_config.json`）

| 调用                                                         | 参数列表                          | 默认值   | 单位/范围                                                    | 返回   | 说明                                 |
| ------------------------------------------------------------ | --------------------------------- | -------- | ------------------------------------------------------------ | ------ | ------------------------------------ |
| `CreateBullet(id, x, y, speed, angle, speedAcc, angleAcc, offset)` | string, 4×number, 2×number, 1×int | 后三项=0 | speed：像素/秒；x,y:坐标（通常直接用enemy的坐标）angle：角度speedAcc：加速度angleAcc：角加速度offset：精灵图偏移，不可瞎用，必须参考json配置，否则空着 | 无     | 发射单发子弹                         |
| `ClearBullets(turn, id)`                                     | bool                              | false    | id为掉落物配置，暂时不支持自定义                             | 无     | true=有凋落物false=无凋落物          |
| `GetAngleToPlayer(x, y)`                                     | 2×number                          | 必填     | x，y一般直接用宿主（enemy）的位置                            | number | 该点→玩家的角度（deg，0=右，逆时针） |

### 音频（必须参考`data/resource.json`中audio部分提供的音频）

| 调用                 | 参数列表      | 默认值                        | 说明               |
| -------------------- | ------------- | ----------------------------- | ------------------ |
| `PlayBGM(id)`        | string 或 nil | nil=继续上次                  | 切换/继续背景音乐  |
| `PlaySFX(id, track)` | 2×string      | 必填（track是轨道名，随便填） | 在指定轨道播放音效 |

### 关卡流程

| 调用            | 参数 | 说明                     |
| --------------- | ---- | ------------------------ |
| `FinishStage()` | 无   | 立即结束关卡（进入结算） |

------

*DEVELOPED BY CUUPE*
